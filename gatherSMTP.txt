# Connect-MgGraph -Scopes "AuditLog.Read.All", "Directory.Read.All"

$startDate = (Get-Date).AddDays(-30).ToUniversalTime()
$startFilter = $startDate.ToString("yyyy-MM-ddTHH:mm:ssZ")

$endDate = (Get-Date).ToUniversalTime()
$endFilter = $endDate.ToString("yyyy-MM-ddTHH:mm:ssZ")

$filter = "createdDateTime ge $startFilter and createdDateTime le $endFilter and clientAppUsed eq 'Authenticated SMTP' and status/errorCode eq 0"

Write-Host "Using filter: $filter" -ForegroundColor Cyan

try {
    $signIns = Get-MgAuditLogSignIn -Filter $filter -All -ErrorAction Stop

    if ($signIns.Count -eq 0) {
        Write-Host "No legacy SMTP sign-ins found in the date range." -ForegroundColor Yellow
    }
    else {
        Write-Host "Found $($signIns.Count) sign-ins." -ForegroundColor Green

        $results = $signIns |
            Group-Object UserPrincipalName |
            Select-Object `
                @{Name='UserPrincipalName'; Expression={$_.Name}},
                @{Name='SignInCount'; Expression={$_.Count}},
                @{Name='UniqueIPs'; Expression={ ($_.Group.IpAddress | Where-Object { $_ } | Sort-Object -Unique) -join ', ' }},
                @{Name='LastSignIn'; Expression={ ($_.Group.CreatedDateTime | Measure-Object -Maximum).Maximum }},
                @{Name='AppDisplayName'; Expression={ ($_.Group.AppDisplayName | Where-Object { $_ } | Select-Object -Unique) -join ', ' }}

        $results | Format-Table -AutoSize

        $results | Export-Csv -Path "C:\Legacy_SMTP_Users_ExchangeOnline.csv" -NoTypeInformation -Encoding UTF8
    }
}
catch {
    Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
    $_.Exception | Format-List -Force
}
